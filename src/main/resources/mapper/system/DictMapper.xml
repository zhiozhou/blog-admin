<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="priv.zhou.module.system.dict.domain.dao.DictDAO">

    <resultMap id="dictMap" type="DictPO">
        <id column="id" property="id"/>
        <result column="name" property="name"/>
        <result column="key" property="key"/>
        <result column="state" property="state"/>
        <result column="remark" property="remark"/>
        <result column="version" property="version"/>
        <collection property="dataList"  ofType="DictDataPO">
            <result column="code" property="code"/>
            <result column="label" property="label" />
            <result column="data_type" property="type" />
            <result column="top" property="top" />
            <result column="css" property="css" />
        </collection>
    </resultMap>

    <insert id="saveData" parameterType="DictDTO">
        INSERT system_dict_data ( code, label, dict_key, type, top, css )
        VALUES
        <foreach collection="dataList" index="index" item="item" separator=",">
            ( #{item.code},#{item.label},#{key},#{item.type},#{item.top},#{item.css} )
        </foreach>
    </insert>


    <insert id="save" parameterType="DictPO">
        INSERT INTO system_dict
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="name != null  and name != '' "> name ,</if>
            <if test="key != null  and key != '' "> `key` ,</if>
            <if test="state != null  "> state ,</if>
            <if test="remark != null  and remark != '' "> remark ,</if>
            version ,
            create_id,
            modified_id,
            gmt_create,
            gmt_modified
        </trim>
        values
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="name != null and name != ''">#{name} ,</if>
            <if test="key != null and key != ''">#{key} ,</if>
            <if test="state != null">#{state} ,</if>
            <if test="remark != null and remark != ''">#{remark} ,</if>
            0 ,
            #{createId},
            #{createId},
            NOW(),
            NOW()
        </trim>
    </insert>

    <delete id="remove" parameterType="DictDTO">
        delete from system_dict where `key` = #{key}
    </delete>

    <delete id="removeData" parameterType="DictDTO">
         delete from system_dict_data where dict_key = #{key}
    </delete>

    <update id="update" parameterType="DictPO">
        UPDATE system_dict
        <set>
            <if test="name != null and name != ''"> `name` = #{name},</if>
            <if test="key != null and key != ''">`key` = #{key},</if>
            <if test="state != null"> state = #{state},</if>
            <if test="remark != null and remark != ''"> remark = #{remark},</if>
            version = version + 1,
            modified_id = #{modifiedId},
            gmt_modified = NOW()
        </set>
        WHERE id = #{id}
    </update>

    <select id="get" parameterType="DictDTO" resultMap="dictMap">
        SELECT
            system_dict.id,
            name,
            `key`,
            system_dict.state,
            version,
            remark,
            code,
            label,
            dict_key,
            system_dict_data.type data_type,
            top,
            css
        FROM
            system_dict
            LEFT JOIN system_dict_data ON system_dict.key = system_dict_data.dict_key
        WHERE system_dict.id = #{id}
    </select>

    <select id="getData" parameterType="DictDTO" resultType="DictDataPO">
         SELECT
            code,
            label,
            dict_key,
            type,
            top,
            css
        FROM
            system_dict_data
        WHERE dict_key = #{key}
        AND code = #{code}
    </select>

    <select id="list" parameterType="DictDTO" resultType="DictPO">
        SELECT
            id ,
            name ,
            `key` ,
            state ,
            remark,
            version
        FROM system_dict
        <where>
            <if test="nameLike != null and nameLike != ''">and name LIKE CONCAT('%',#{nameLike},'%')</if>
            <if test="keyLike != null and keyLike != ''">and `key` LIKE CONCAT('%',#{keyLike},'%')</if>
            <if test="state != null"> and state = #{state}</if>
        </where>
        ORDER BY id DESC
    </select>

    <select id="listData" parameterType="DictDTO" resultType="DictDataPO">
         SELECT
            code,
            label,
            dict_key,
            type,
            top,
            css
        FROM
            system_dict_data
        WHERE
            system_dict_data.dict_key = #{key}
        <if test="dataType != null"> and type = #{dataType}</if>
    </select>


    <select id="count" parameterType="DictDTO" resultType="Integer">
        SELECT
            COUNT(0)
        FROM
        system_dict
        <where>
            <if test="noid != null ">and id != #{noid}</if>
            <if test="name != null and name != ''"> and name = #{name}</if>
            <if test="key != null and key != ''"> and `key` = #{key}</if>
        </where>
    </select>
</mapper>
